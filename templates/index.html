<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Matrix Control</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>LED Matrix Control</h1>
            <div class="status-indicators">
                <div class="status-item" id="status-pi" title="Raspberry Pi Connection">
                    <span class="status-dot"></span> Raspberry Pi
                </div>
                <div class="status-item">
                    <span>{{ user.username }}</span>
                    <a href="{{ url_for('logout') }}" class="tool-btn danger" style="text-decoration: none; font-size: 12px; padding: 2px 8px;">Logout</a>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('draw')">Draw</button>
            <button class="tab-btn" onclick="openTab('upload')">Upload</button>
            {% if user.is_admin %}
            <button class="tab-btn" onclick="openTab('sdcard')">SD Card</button>
            <button class="tab-btn" onclick="openTab('admin')">Admin</button>
            <button class="tab-btn" onclick="openTab('settings')">Settings</button>
            {% endif %}
        </div>

        <!-- Draw Tab -->
        <div id="draw" class="tab-content active">
            <div class="toolbar">
                <div class="tool-group">
                    <label>Color:</label>
                    <input type="color" id="colorPicker" value="#ff0000">
                </div>
                <div class="tool-group">
                    <label>Size:</label>
                    <input type="range" id="brushSize" min="1" max="10" value="1">
                    <span id="brushSizeVal">1</span>
                </div>
                <div class="tool-group">
                    <button onclick="setTool('brush')" class="tool-btn active" id="btn-brush" title="Brush">Brush</button>
                    <button onclick="setTool('eraser')" class="tool-btn" id="btn-eraser" title="Eraser">Eraser</button>
                    <button onclick="setTool('bucket')" class="tool-btn" id="btn-bucket" title="Bucket Fill">Bucket</button>
                </div>
                <div class="tool-group">
                    <button onclick="undo()" class="tool-btn" id="btn-undo" title="Undo (Ctrl+Z)">Undo</button>
                    <button onclick="redo()" class="tool-btn" id="btn-redo" title="Redo (Ctrl+Y)">Redo</button>
                    <button onclick="clearCanvas()" class="tool-btn danger" title="Clear Canvas">Clear</button>
                </div>
            </div>
            
            <div class="canvas-container" id="canvasContainer">
                <!-- 128x64 logical resolution, scaled up in CSS -->
                <canvas id="pixelCanvas" width="128" height="64"></canvas>
                <div class="split-line"></div>
                <button onclick="toggleFullscreen()" class="fullscreen-btn" title="Toggle Fullscreen">⛶</button>
            </div>
            
            <button onclick="sendDrawing()" class="action-btn">Update Matrix</button>
        </div>

        <!-- Upload Tab -->
        <div id="upload" class="tab-content">
            <div class="upload-form">
                <h3>Upload Image/GIF/Video</h3>
                
                <div class="mode-selection">
                    <label class="mode-card">
                        <input type="radio" name="mode" value="matrix_a" onchange="updateUploadInputs()">
                        <div class="mode-info">
                            <span class="mode-title">Matrix A Only</span>
                            <span class="mode-desc">Display on the left matrix only.</span>
                        </div>
                    </label>
                    <label class="mode-card">
                        <input type="radio" name="mode" value="matrix_b" onchange="updateUploadInputs()">
                        <div class="mode-info">
                            <span class="mode-title">Matrix B Only</span>
                            <span class="mode-desc">Display on the right matrix only.</span>
                        </div>
                    </label>
                    <label class="mode-card">
                        <input type="radio" name="mode" value="both" onchange="updateUploadInputs()">
                        <div class="mode-info">
                            <span class="mode-title">Both (Clone)</span>
                            <span class="mode-desc">Show the same image on both matrices.</span>
                        </div>
                    </label>
                    <label class="mode-card">
                        <input type="radio" name="mode" value="split" checked onchange="updateUploadInputs()">
                        <div class="mode-info">
                            <span class="mode-title">Split (Span)</span>
                            <span class="mode-desc">One image spans across both matrices (128x64).</span>
                        </div>
                    </label>
                    <label class="mode-card">
                        <input type="radio" name="mode" value="separate" onchange="updateUploadInputs()">
                        <div class="mode-info">
                            <span class="mode-title">Separate Files</span>
                            <span class="mode-desc">Upload different files for each matrix.</span>
                        </div>
                    </label>
                </div>

                <div class="file-inputs">
                    <div id="input-group-a">
                        <label>File (Main/A):</label>
                        <input type="file" id="fileA" accept="image/*,video/*">
                    </div>
                    
                    <div id="input-group-b" style="display: none;">
                        <label>File (Matrix B):</label>
                        <input type="file" id="fileB" accept="image/*,video/*">
                    </div>
                </div>

                <div class="action-row">
                    <button onclick="uploadFiles()" class="action-btn">Upload to Matrix</button>
                    <button onclick="clearMatrix()" class="action-btn danger">Clear Matrix</button>
                </div>
                <div id="uploadStatus"></div>
            </div>
        </div>

        <!-- SD Card Tab -->
        <div id="sdcard" class="tab-content">
            <div class="upload-form">
                <h3>SD Card Management</h3>
                <p>Upload files here to be stored on the Raspberry Pi's SD card. These files will be displayed when the "SD Card Fallback" mode is active (e.g., when screens are cleared/black).</p>
                
                <div class="mode-selection">
                    <label class="mode-card">
                        <input type="radio" name="sd_mode" value="matrix_a">
                        <div class="mode-info">
                            <span class="mode-title">Matrix A Only</span>
                        </div>
                    </label>
                    <label class="mode-card">
                        <input type="radio" name="sd_mode" value="matrix_b">
                        <div class="mode-info">
                            <span class="mode-title">Matrix B Only</span>
                        </div>
                    </label>
                    <label class="mode-card">
                        <input type="radio" name="sd_mode" value="both" checked>
                        <div class="mode-info">
                            <span class="mode-title">Both (Clone)</span>
                        </div>
                    </label>
                    <label class="mode-card">
                        <input type="radio" name="sd_mode" value="split">
                        <div class="mode-info">
                            <span class="mode-title">Split (Span)</span>
                        </div>
                    </label>
                </div>

                <div class="file-inputs">
                    <div id="input-group-sd">
                        <label>Select File:</label>
                        <input type="file" id="fileSD" accept="image/*,video/*">
                    </div>
                </div>

                <div class="action-row">
                    <button onclick="uploadSDFile()" class="action-btn">Upload to SD Card</button>
                    <button onclick="playSDCard()" class="action-btn success">Play from SD Card</button>
                    <button onclick="stopSDCard()" class="action-btn danger">Stop Playback</button>
                </div>
                <div id="sdUploadStatus"></div>
                
                <hr style="border-color: #444; margin: 20px 0;">
                
                <h3>Stored Files</h3>
                <div id="sd-file-list" class="user-list">
                    <p>Loading files...</p>
                </div>
            </div>
        </div>

        {% if user.is_admin %}
        <!-- Admin Tab -->
        <div id="admin" class="tab-content">
            <h3>User Management</h3>
            <div id="user-list" class="user-list">
                <!-- Users will be loaded here -->
                <p>Loading users...</p>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="settings-container">
                <div class="telemetry-section">
                    <h3>Live Status</h3>
                    <div id="telemetry-data" class="telemetry-grid">
                        <div class="telemetry-item">
                            <span class="label">Status:</span>
                            <span class="value" id="tel-status">Unknown</span>
                        </div>
                        <div class="telemetry-item">
                            <span class="label">IP Address:</span>
                            <span class="value" id="tel-ip">-</span>
                        </div>
                        <div class="telemetry-item">
                            <span class="label">Network:</span>
                            <span class="value" id="tel-network">-</span>
                        </div>
                        <div class="telemetry-item">
                            <span class="label">Refresh Rate:</span>
                            <span class="value" id="tel-refresh">-</span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h3>Client Configuration</h3>
                    <form id="config-form" onsubmit="event.preventDefault(); saveSettings();">
                        <div class="form-group">
                            <label>Brightness (0-100)</label>
                            <input type="range" id="conf-brightness" min="0" max="100" oninput="document.getElementById('val-brightness').textContent = this.value">
                            <span id="val-brightness" class="range-val">50</span>
                        </div>

                        <div class="form-group">
                            <label>Matrix Hardware</label>
                            <div class="grid-2">
                                <div>
                                    <label>Rows</label>
                                    <input type="number" id="conf-rows" value="64">
                                </div>
                                <div>
                                    <label>Cols</label>
                                    <input type="number" id="conf-cols" value="64">
                                </div>
                                <div>
                                    <label>Chain Length</label>
                                    <input type="number" id="conf-chain" value="2">
                                </div>
                                <div>
                                    <label>Parallel</label>
                                    <input type="number" id="conf-parallel" value="1">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Performance & Quality</label>
                            <div class="grid-2">
                                <div>
                                    <label>GPIO Slowdown (0-4)</label>
                                    <input type="number" id="conf-gpio" min="0" max="4">
                                </div>
                                <div>
                                    <label>PWM LSB (ns)</label>
                                    <input type="number" id="conf-pwm" value="130">
                                </div>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="conf-pulsing">
                                <label for="conf-pulsing">Hardware Pulsing (Sound)</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>SD Card Playback</label>
                            <div class="grid-2">
                                <div>
                                    <label>Slide Duration (s)</label>
                                    <input type="number" id="conf-slide-duration" step="0.1" value="30.0">
                                </div>
                                <div>
                                    <label>Video FPS</label>
                                    <input type="number" id="conf-video-fps" step="0.1" value="30.0">
                                </div>
                                <div>
                                    <label>Playlist Refresh (s)</label>
                                    <input type="number" id="conf-playlist-refresh" step="0.1" value="10.0">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Network</label>
                            <div class="grid-2">
                                <div>
                                    <label>Polling Rate (s)</label>
                                    <input type="number" id="conf-polling" step="0.1">
                                </div>
                                <div>
                                    <label>Request Rate (s)</label>
                                    <input type="number" id="conf-req-rate" step="0.1">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Orientation</label>
                            <div class="grid-2">
                                <div>
                                    <label>Position 1 (Rotation)</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <button type="button" class="tool-btn" onclick="rotatePosition1()" title="Rotate 90°" style="font-size: 18px; padding: 5px 12px;">↻</button>
                                        <span id="val-pos1" style="font-size: 18px; font-weight: bold;">0</span><span style="font-size: 18px;">°</span>
                                        <input type="hidden" id="conf-pos1">
                                    </div>
                                </div>
                                <div>
                                    <label>Position 2</label>
                                    <input type="number" id="conf-pos2">
                                </div>
                            </div>
                        </div>

                        <hr style="border-color: #444; margin: 20px 0;">
                        <h3>WiFi Configuration</h3>
                        
                        <div class="form-group">
                            <label>WiFi SSID</label>
                            <input type="text" id="conf-wifi-ssid" placeholder="Enter SSID">
                        </div>
                        <div class="form-group">
                            <label>WiFi Password</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="password" id="conf-wifi-pass" placeholder="Enter Password">
                                <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap; margin: 0; cursor: pointer; color: #aaa; font-size: 14px;">
                                    <input type="checkbox" onchange="togglePasswordVisibility('conf-wifi-pass')" style="width: auto;"> Show
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="conf-no-wifi-update">
                                <label for="conf-no-wifi-update">Do not update WiFi on device</label>
                            </div>
                        </div>

                        <button type="submit" class="action-btn">Save Configuration</button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <div id="toast-container"></div>
</body>
</html>
